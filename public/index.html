<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyTube</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #0f0f0f; color: white; }
    header { display: flex; padding: 10px; background: #202020; align-items: center; gap: 10px; }
    input { flex: 1; padding: 8px; border-radius: 4px; border: none; }
    button { padding: 8px 12px; background: red; color: white; border: none; border-radius: 4px; cursor: pointer; }
    main { padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; }
    .video-card { background: #181818; border-radius: 8px; overflow: hidden; cursor: pointer; }
    .video-card img { width: 100%; display: block; }
    .video-card h3 { padding: 8px; font-size: 14px; }
    iframe { width: 100%; height: 315px; }
    @media (max-width: 600px) {
      main { grid-template-columns: 1fr; }
      iframe { height: 200px; }
    }
  </style>
</head>
<body>

<header>
  <input id="searchInput" type="text" placeholder="Buscar vídeos...">
  <button onclick="searchVideos()">Buscar</button>
  <button id="loginBtn" onclick="login()">Login</button>
  <button id="logoutBtn" style="display:none;" onclick="logout()">Sair</button>
</header>

<section id="recommendations" style="padding:10px;">
  <h2>Recomendados para você</h2>
  <div id="recContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px;"></div>
</section>

<main id="videoContainer"></main>

<section id="playerSection" style="display:none; padding:10px;">
  <iframe id="videoPlayer" frameborder="0" allowfullscreen></iframe>
</section>

<script type="module">
  // Firebase Config
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  const firebaseConfig = {
  
  apiKey: "AIzaSyBXYW36DiAedQIsP-nZ3ouJbztGZMKuZJ4",
  authDomain: "hobbit-30087.firebaseapp.com",
  projectId: "hobbit-30087",
  storageBucket: "hobbit-30087.firebasestorage.app",
  messagingSenderId: "534141903386",
  appId: "1:534141903386:web:589d45ba5b1378f0dd67a3",
  measurementId: "G-REK9Z693CL"
};
 

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("loginBtn").style.display = "none";
      document.getElementById("logoutBtn").style.display = "block";
      loadRecommendations();
    } else {
      currentUser = null;
      document.getElementById("loginBtn").style.display = "block";
      document.getElementById("logoutBtn").style.display = "none";
    }
  });

  async function login() {
    const email = prompt("Digite seu email:");
    const senha = prompt("Digite sua senha:");
    try {
      await signInWithEmailAndPassword(auth, email, senha);
      alert("Login bem-sucedido!");
    } catch {
      if (confirm("Usuário não encontrado. Criar conta?")) {
        await createUserWithEmailAndPassword(auth, email, senha);
        await setDoc(doc(db, "users", email), { history: [] });
      }
    }
  }

  function logout() {
    signOut(auth);
  }

  async function searchVideos() {
    const query = document.getElementById("searchInput").value;
    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
    const data = await res.json();
    renderVideos(data.items);
  }

  function renderVideos(videos) {
    const container = document.getElementById("videoContainer");
    container.innerHTML = "";
    videos.forEach(v => {
      const card = document.createElement("div");
      card.className = "video-card";
      card.innerHTML = `
        <img src="${v.snippet.thumbnails.medium.url}" alt="">
        <h3>${v.snippet.title}</h3>
      `;
      card.onclick = () => playVideo(v.id.videoId, v.snippet.title);
      container.appendChild(card);
    });
  }

  async function playVideo(videoId, title) {
    document.getElementById("playerSection").style.display = "block";
    document.getElementById("videoPlayer").src = `https://www.youtube.com/embed/${videoId}`;
    if (currentUser) {
      const userRef = doc(db, "users", currentUser.email);
      await updateDoc(userRef, {
        history: arrayUnion({ videoId, title, ts: Date.now() })
      });
    }
  }

  async function loadRecommendations() {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.email);
    const snap = await getDoc(userRef);
    if (!snap.exists()) return;
    const history = snap.data().history || [];
    const keywords = history.map(h => h.title.split(" ")).flat();
    const mostCommon = keywords.slice(-3).join(" ");
    if (mostCommon) {
      const res = await fetch(`/api/search?q=${encodeURIComponent(mostCommon)}`);
      const data = await res.json();
      renderRecommendations(data.items);
    }
  }

  function renderRecommendations(videos) {
    const container = document.getElementById("recContainer");
    container.innerHTML = "";
    videos.forEach(v => {
      const card = document.createElement("div");
      card.className = "video-card";
      card.innerHTML = `
        <img src="${v.snippet.thumbnails.medium.url}" alt="">
        <h3>${v.snippet.title}</h3>
      `;
      card.onclick = () => playVideo(v.id.videoId, v.snippet.title);
      container.appendChild(card);
    });
  }
</script>

</body>
</html>
